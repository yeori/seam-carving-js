!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.seamcarving=t():e.seamcarving=t()}(self,(function(){return(()=>{"use strict";var e={d:(t,i)=>{for(var n in i)e.o(i,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:i[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function r(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}e.r(t),e.d(t,{SeamCarving:()=>S,default:()=>C,init:()=>x});var a=function(){function e(t){i(this,e),this.expression=t}return r(e,[{key:"isClass",get:function(){return"."===this.expression.charAt(0)}},{key:"isId",get:function(){return"#"===this.expression.charAt(0)}},{key:"value",get:function(){return this.expression.substring(1)}},{key:"setAttribute",value:function(e){if(this.isId)e.setAttribute("id",this.value);else{if(!this.isClass)throw new Error("neither id nor class : [".concat(this.expression,"]"));e.classList.add(this.value)}}}]),e}(),o=new Set,s=function(){function e(){i(this,e),this.el=document.createComment("dummy el for event bus"),this.callbacks=new Map}return r(e,[{key:"on",value:function(e,t){var i=this.callbacks.get(e);i||(i=new Set,this.callbacks.set(e,i)),i.add(t)}},{key:"emit",value:function(e,t){(this.callbacks.get(e)||o).forEach((function(e){try{e(t)}catch(e){console.log(e)}}))}},{key:"hasListeners",value:function(e){return!!this.callbacks.get(e)}}]),e}(),h=function(e){return(e||"").split(" ").map((function(e){return e.trim()})).filter((function(e){return e.length>0}))},u=function(e,t,i){var n=document.createElement(e);return t.forEach((function(e){new a(e).setAttribute(n)})),i&&i.appendChild(n),n};const c=function(e,t){return u("CANVAS",h(e),t)},l=function(){return new s};function f(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var v=1e3,g=function(e,t,i){var n=4*e,r=4*t,a=i[n+0]-i[r+0],o=i[n+1]-i[r+1],s=i[n+2]-i[r+2];return a*a+o*o+s*s},d=function(e,t,i,n,r){var a=i<0?n:e[i]<e[n]?i:n;return r===t||e[a]<=e[r]?a:r},m=function(e,t,i,n,r,a,o){var s=i-a,h=i+a,u=g(i-1,i+1,e),c=g(s,h,e);t[i]=u+c},p=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var i=c(null,t);i.width=0,i.height=0,this.$canvas=i,this.$$={}}var t,i;return t=e,(i=[{key:"setImageSource",value:function(e){this.$$.imgSource=e;var t=this.$canvas,i=e.width,n=e.height;t.width=i,t.height=n,t.style.width="".concat(i,"px"),t.style.height="".concat(n,"px");var r=t.getContext("2d");this.$$.ctx=r,this.$$.viewport={width:i,height:n};var a=i*n;this.energies=new Uint32Array(a),this.repaint(),function(e,t,i,n,r){var a,o,s,h,u=t.data,c=i.width,l=i.height,f=0;a=n,e.fill(v,f,a),a=(f=(l-1)*n)+n,e.fill(v,f,a);for(var d=1;d<l-1;d++){e[f=d*n]=v,e[f+c-1]=v;for(var m=1;m<c-1;m++){s=(o=f+m)-n,h=o+n;var p=g(o-1,o+1,u),w=g(s,h,u);e[o]=p+w}}}(this.energies,this.$$.imageData,this.$$.viewport,this.width,this.height)}},{key:"cutVSeam",value:function(){this.$$.vseam||this.resolveVerticalSeam();for(var e,t=this.energies,i=this.$$,n=i.vseam,r=i.viewport,a=i.imageData.data,o=this.width,s=(this.height,0);s<r.height;s++){var h=(e=o*s+n[s])+1,u=o*s+r.width;a.copyWithin(4*e,4*h,4*u),t.copyWithin(e,h,u)}r.width-=1,this.$$.vseam=null;for(var c=1;c<r.height-1;c++){var l=n[c];e=o*c+l,l>0&&(m(a,t,e,0,0,o),l-1>0&&m(a,t,e-4,0,0,o))}this.repaint()}},{key:"renderVerticalSeam",value:function(e){var t=this.$$,i=t.ctx,n=t.viewport;i.strokeStyle="#ff0000",i.beginPath(),i.moveTo(e[0],0);for(var r=1;r<n.height;r++)i.lineTo(e[r],r);i.stroke()}},{key:"repaint",value:function(){var e=this.$$,t=e.ctx,i=e.imgSource,n=e.imageData;t.clearRect(0,0,this.width,this.height),n||(t.drawImage(i.image,0,0),this.$$.imageData=t.getImageData(0,0,this.width,this.height)),t.putImageData(this.$$.imageData,0,0,0,0,this.viewportWidth,this.viewportHeight)}},{key:"resolveVerticalSeam",value:function(e){var t=function(e,t,i,n){for(var r=[],a=t.width,o=t.height,s=e.slice(0,i),h=[],u=1;u<o;u++){h=e.slice(u*i,u*i+i);for(var c=new Array(a),l=0;l<a;l++){var f=d(s,a,l-1,l,l+1);c[l]=f,h[l]+=s[f]}r.push(c),s=h}var v=0;h.forEach((function(e,t){t<a&&e<h[v]&&(v=t)}));for(var g=[v],m=r.length-1;m>=0;m--)v=r[m][v],g.push(v);return g.reverse()}(this.energies,this.$$.viewport,this.width,this.height);this.$$.vseam=t,e&&this.renderVerticalSeam(t)}},{key:"capture",value:function(){var e=this.$$.ctx,t=this.$$.viewport,i=t.width,n=t.height,r=e.getImageData(0,0,i,n),a=document.createElement("canvas");return a.width=i,a.height=n,a.getContext("2d").putImageData(r,0,0),{width:i,height:n,type:"data-url",image:a.toDataURL()}}},{key:"width",get:function(){return this.$$.imgSource.width}},{key:"height",get:function(){return this.$$.imgSource.height}},{key:"viewportWidth",get:function(){return this.$$.viewport.width}},{key:"viewportHeight",get:function(){return this.$$.viewport.height}}])&&f(t.prototype,i),e}();function w(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function $(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function y(e,t,i){return t&&$(e.prototype,t),i&&$(e,i),e}var b={progress:"progress",done:"done"},k=function(){function e(t,i){w(this,e),this.$$={listener:null,seamCarving:t,limit:i,current:0,stats:[],dim:{imageWidth:t.imageWidth,imageHeight:t.imageHeight}};var n=t.eventBus.hasListeners(b.progress),r=t.eventBus.hasListeners(b.done);(n||r)&&(this.$$.listener={progress:n,done:r})}return y(e,[{key:"start",value:function(){var e=this,t=this.$$,i=t.listener,n=t.limit,r=t.current,a=t.seamCarving,o=t.stats,s=t.dim;if(r===n){if(i&&i.done){var h=o.reduce((function(e,t){return e+t.elapsed}),0),u=h/o.length;a.eventBus.emit(b.done,{index:r,limit:n,totalTime:h,avgTime:u,stats:o,dim:s})}}else setTimeout((function(){var t=performance.now();a.canvas.cutVSeam();var h=performance.now()-t,u=null;i&&(u={index:r,limit:n,elapsed:h,dim:Object.assign({viewportWidth:a.viewportWidth,viewportHeight:a.viewportHeight},s)}),i&&i.done&&o.push(u),i&&i.progress&&a.eventBus.emit(b.progress,u),e.$$.current++,e.start()}))}}]),e}(),S=function(){function e(t){w(this,e),this.$$={},this.$$.$wrapper=t,this.canvas=new p(t),this.$$.ebus=l()}return y(e,[{key:"render",value:function(e){var t=this;!function(e,t){var i=new Image;i.onload=function(){t(i)},i.src=window.URL.createObjectURL(e)}(e,(function(i){t.$$.imageSource={image:i,width:i.width,height:i.height,size:e.size,originName:e.name},t.canvas.setImageSource(t.$$.imageSource)}))}},{key:"renderVSeam",value:function(){this.canvas.resolveVerticalSeam(!0)}},{key:"cutVSeam",value:function(e){return new k(this,e||1).start(),this}},{key:"on",value:function(e,t){var i=function(e){var t=b[e];if(!t)throw new Error("invalid event [".concat(e,"]. 'progress' and 'done' are supported."));return t}(e);return this.eventBus.on(i,t),this}},{key:"capture",value:function(){var e=this.canvas.capture();return e.fileName=this.$$.imageSource.originName,e}},{key:"eventBus",get:function(){return this.$$.ebus}},{key:"imageWidth",get:function(){return this.$$.imageSource.width}},{key:"imageHeight",get:function(){return this.$$.imageSource.height}},{key:"viewportWidth",get:function(){return this.canvas.viewportWidth}},{key:"viewportHeight",get:function(){return this.canvas.viewportHeight}}]),e}(),x=function(e){return new S(e)};const C={SeamCarving:S};return t})()}));
//# sourceMappingURL=seamcarving.js.map